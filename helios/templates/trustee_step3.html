{% extends "helios/templates/cryptobase.html" %}
{% block content %}
<script language="javascript">

var PARAMS, CERTIFICATES, TRUSTEE;
var COEFFICIENTS, POINTS;

var SENT, ACKS;
var SUM = BigInteger.ZERO;

var check_acks = {
    trustee: function (i) {
        var log = this.log;
        if (i < PARAMS.l) {
            var id = i+1;
            log("Checking acknowledgement from trustee #" + id + "...");
            setTimeout(function () {
                var pk = check_acks.pk;
                pk.y = new BigInt(CERTIFICATES[i].signature_key);
                if (TRUSTEE.check_ack(id, pk, SENT[i], ACKS[i])) {
                    setTimeout(function () { check_acks.trustee(i+1); }, 500);
                } else {
                    log("Trustee #" + id + " did not acknowledge!");
                }
            }, 500);
        } else {
            log("SUCCESS!");
            $("#compute_secret_share").show();
        }
    },

    start: function () {
        $("#check_acks_button").hide();
        $("#check_acks_log").show();
        this.log = heliosc.ui.logger("check_acks_log");
        this.pk = { g: PARAMS.g, p: PARAMS.p, q: PARAMS.q };
        this.trustee(0);
    }
};

function prepare_upload() {
    var pk = {
        g: PARAMS.g.toString(),
        p: PARAMS.p.toString(),
        q: PARAMS.q.toString(),
        y: PARAMS.g.modPow(SUM, PARAMS.p).toString()
    };
    $("#upload_textarea").val(jQuery.toJSON(pk));
    $("#upload").show();
};

// start collecting some local randomness
sjcl.random.startCollectors();

$(document).ready(function() {
    // get some more server-side randomness for keygen
    $.getJSON('../../get-randomness', function(result) {
       sjcl.random.addEntropy(result.randomness);
       BigInt.setup(function() {
          PARAMS = ElGamal.Params.fromJSONObject({{params|safe}});
          PARAMS.trustee_id = {{trustee.trustee_id}};
          CERTIFICATES = {{certificates|safe}};
          COEFFICIENTS = {{coefficients|safe}};
          POINTS = {{points|safe}};
          SENT = {{points_sent|safe}};
          ACKS = {{acks|safe}};
       });
    });
});

</script>

<h2 class="title">{{election.name}} &mdash; Trustee {{trustee.name}} &mdash; Step 3</h2>

<p></p>

<div>
  As trustee #{{trustee.trustee_id}}, it's time to complete step 3 of the distributed key
  generation algorithm.
</div>

<p></p>

<div>
  <hr/>
  First, check the certificates generated by all trustees:
  <button id="check_certificates_button" onclick="heliosc.ui.validator.start(); return false;">Check</button>
</div>

<div id="check_certificates_log" style="display:none;">
</div>

<p></p>

<div id="input_secret_key" style="display:none;">
  <hr/>
  Then, load your secret key:
  <button id="input_secret_key_button" onclick="heliosc.ui.load_secret_key('#check_acks'); return false;">Load</button>
  <span id="input_secret_key_done" style="display:none;"><b>secret key successfully loaded!</b></span>
</div>

<p></p>

<div id="public_key_fingerprint" style="display:none;">
  Public key fingerprint: <b>{{trustee.public_key_hash}}</b>
</div>

<div id="check_acks" style="display:none;">
  <hr/>
  Now, check that your points were correctly acknowledged:
  <button id="check_acks_button" onclick="check_acks.start(); return false;">Check</button>
</div>

<div id="check_acks_log" style="display:none;">
</div>

<div id="compute_secret_share" style="display:none;">
  <hr/>
  Now, compute your secret share:
  <button id="compute_secret_share_button" onclick="heliosc.ui.share.start(prepare_upload); return false;">Compute</button>
</div>

<div id="compute_secret_share_log" style="display:none;">
</div>

<div id="upload" style="display:none;">
  <hr/>
  Finally, upload your public verification key to the election server:

  <form method="post" action="{% url helios.views.trustee_step3 election.uuid, trustee.uuid %}">
    <textarea id="upload_textarea" name="verification_key" cols="80" rows="10" style="display:none;"></textarea>
    <input type="submit"></input>
  </form>
</div>

{% endblock %}
