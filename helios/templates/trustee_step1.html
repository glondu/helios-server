{% extends "helios/templates/cryptobase.html" %}
{% block content %}
<script language="javascript">

var PARAMS, CERTIFICATES, TRUSTEE;
var COEFFICIENTS = [], POINTS = [];

var derivator = {
    coeff: function (i) {
        if (i <= PARAMS.t) {
            this.log("Generating coefficient #" + i + "...");
            setTimeout(function () {
                COEFFICIENTS[i] = TRUSTEE.generate_coefficient(i);
                setTimeout(function () { derivator.coeff(i+1); }, 500);
            }, 500);
        } else {
            this.point(0);
        }
    },

    point: function (i) {
        if (i < PARAMS.l) {
            var id = i+1;
            this.log("Generating point shared with trustee #" + id + "...");
            setTimeout(function () {
                derivator.pk.y = new BigInt(CERTIFICATES[i].encryption_key);
                POINTS[i] = TRUSTEE.generate_point(id, derivator.pk);
                setTimeout(function () { derivator.point(i+1); }, 500);
            }, 500);
        } else {
            this.log("SUCCESS!");
            $("#coefficients_textarea").val(jQuery.toJSON(COEFFICIENTS));
            $("#points_textarea").val(jQuery.toJSON(POINTS));
            $("#upload").show();
        }
    },

    start: function () {
        $("#derive_button").hide();
        $("#derive_log").show();
        this.log = heliosc.ui.logger("derive_log");
        this.pk = { g: PARAMS.g, p: PARAMS.p, q: PARAMS.q };
        this.coeff(0);
    }
};

// start collecting some local randomness
sjcl.random.startCollectors();

$(document).ready(function() {
    // get some more server-side randomness for keygen
    $.getJSON('../../get-randomness', function(result) {
       sjcl.random.addEntropy(result.randomness);
       BigInt.setup(function() {
          PARAMS = ElGamal.Params.fromJSONObject({{params|safe}});
          PARAMS.trustee_id = {{trustee.trustee_id}};
          CERTIFICATES = {{certificates|safe}};
       });
    });
});

</script>

<h2 class="title">{{election.name}} &mdash; Trustee {{trustee.name}} &mdash; Step 1</h2>

<p></p>

<div>
  As trustee #{{trustee.trustee_id}}, it's time to complete step 1 of the distributed key
  generation algorithm.
</div>

<p></p>

<div>
  <hr/>
  First, check the certificates generated by all trustees:
  <button id="check_certificates_button" onclick="heliosc.ui.validator.start(); return false;">Check</button>
</div>

<div id="check_certificates_log" style="display:none;">
</div>

<p></p>

<div id="input_secret_key" style="display:none;">
  <hr/>
  Then, load your secret key:
  <button id="input_secret_key_button" onclick="heliosc.ui.load_secret_key('#derive'); return false;">Load</button>
  <span id="input_secret_key_done" style="display:none;"><b>secret key successfully loaded!</b></span>
</div>

<p></p>

<div id="public_key_fingerprint" style="display:none;">
  Public key fingerprint: <b>{{trustee.public_key_hash}}</b>
</div>

<div id="derive" style="display:none;">
  <hr/>
  Now, compute the data required for the algorithm:
  <button id="derive_button" onclick="derivator.start(); return false;">Compute</button>
</div>

<div id="derive_log" style="display:none;">
</div>

<div id="upload" style="display:none;">
  <hr/>
  Finally, upload the data to the election server:

  <form method="post" action="{% url helios.views.trustee_step1 election.uuid, trustee.uuid %}">
    <textarea id="coefficients_textarea" name="coefficients" cols="80" rows="10" style="display:none;"></textarea>
    <textarea id="points_textarea" name="points" cols="80" rows="10" style="display:none;"></textarea>
    <input type="submit"></input>
  </form>
</div>

{% endblock %}
