{% extends "helios/templates/cryptobase.html" %}
{% block content %}
<script language="javascript">

var PARAMS, CERTIFICATES, TRUSTEE;
var COEFFICIENTS, POINTS;

var ACKS = [];

var acknowledger = {
    trustee: function (i) {
        if (i < PARAMS.l) {
            var id = i+1;
            this.log("Checking point shared with trustee #" + id + "...");
            setTimeout(function () {
                var pk = acknowledger.pk;
                pk.y = new BigInt(CERTIFICATES[i].signature_key);
                var ack = TRUSTEE.check_point(id, pk, POINTS[i], COEFFICIENTS[i]);
                if (ack) {
                    ACKS[i] = ack;
                    setTimeout(function () { acknowledger.trustee(i+1); }, 500);
                } else {
                    acknowledger.log("Point from trustee #" + id + " failed validation!");
                }
            }, 500);
        } else {
            this.log("SUCCESS!");
            $("#acknowledgements_textarea").val(jQuery.toJSON(ACKS));
            $("#upload").show();
        }
    },

    start: function () {
        $("#acknowledge_button").hide();
        $("#acknowledge_log").show();
        this.log = heliosc.ui.logger("acknowledge_log");
        this.pk = { g: PARAMS.g, p: PARAMS.p, q: PARAMS.q };
        this.trustee(0);
    }
};

// start collecting some local randomness
sjcl.random.startCollectors();

$(document).ready(function() {
    // get some more server-side randomness for keygen
    $.getJSON('../../get-randomness', function(result) {
       sjcl.random.addEntropy(result.randomness);
       BigInt.setup(function() {
          PARAMS = ElGamal.Params.fromJSONObject({{params|safe}});
          PARAMS.trustee_id = {{trustee.trustee_id}};
          CERTIFICATES = {{certificates|safe}};
          COEFFICIENTS = {{coefficients|safe}};
          POINTS = {{points|safe}};
       });
    });
});

</script>

<h2 class="title">{{election.name}} &mdash; Trustee {{trustee.name}} &mdash; Step 2</h2>

<p></p>

<div>
  As trustee #{{trustee.trustee_id}}, it's time to complete step 2 of the distributed key
  generation algorithm.
</div>

<p></p>

<div>
  <hr/>
  First, check the certificates generated by all trustees:
  <button id="check_certificates_button" onclick="heliosc.ui.validator.start(); return false;">Check</button>
</div>

<div id="check_certificates_log" style="display:none;">
</div>

<p></p>

<div id="input_secret_key" style="display:none;">
  <hr/>
  Then, load your secret key:
  <button id="input_secret_key_button" onclick="heliosc.ui.load_secret_key('#acknowledge'); return false;">Load</button>
  <span id="input_secret_key_done" style="display:none;"><b>secret key successfully loaded!</b></span>
</div>

<p></p>

<div id="public_key_fingerprint" style="display:none;">
  Public key fingerprint: <b>{{trustee.public_key_hash}}</b>
</div>

<div id="acknowledge" style="display:none;">
  <hr/>
  Now, check the data computed by all trustees:
  <button id="acknowledge_button" onclick="acknowledger.start(); return false;">Check</button>
</div>

<div id="acknowledge_log" style="display:none;">
</div>

<div id="upload" style="display:none;">
  <hr/>
  Finally, upload the acknowledgements to the election server:

  <form method="post" action="{% url helios.views.trustee_step2 election.uuid, trustee.uuid %}">
    <textarea id="acknowledgements_textarea" name="acknowledgements" cols="80" rows="10" style="display:none;"></textarea>
    <input type="submit"></input>
  </form>
</div>

{% endblock %}
